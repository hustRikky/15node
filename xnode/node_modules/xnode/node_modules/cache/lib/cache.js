/**
 * NodeX version 0.0.1
 * Created by mR.Rikkyâ„¢
 * Date: 6/4/13
 * Time: 10:58 AM
 */
require('colors');
var job = require('./job');


var __pool = {};
var jobs = {};
var logger = function(message){
    var msg = 'CACHE'.yellow+ '\t' + message;
    console.log(msg);
}

var cache = function(){
    logger('STARTED'.green.bold);
    return cache;
}

module.exports = cache;

module.exports.set = function(key, value, expire, onExpired){
    if(jobs[key.toString()] != null){
        job.deleteJob(jobs[key.toString()]);
    }
    if(expire != null && parseInt(expire) > 0){
        jobs[key.toString()] = job.createJob(parseInt(expire), function(){
            logger('EXP\t'.blue + key.grey);
            cache.del(key.toString());
            if(onExpired != null){
                onExpired({'key':key.toString(), 'value':__pool[key.toString()]});
            }
        });
    }
    __pool[key.toString()] = value;
    logger('SET\t'.magenta + (key.toString() + ':\t').grey + value.toString());
}

module.exports.get = function(key){
    var result = __pool[key.toString()] ? __pool[key.toString()] : null
    if(result != null){
        logger('GET\t'.cyan + key.toString().grey + ':\t'.grey + result.toString());
    } else {
        logger('GET\t'.cyan + (key.toString()+':\tnull').grey);
    }
    return result;
}

module.exports.del = function(key, callback){
    if(__pool[key.toString()]!=null){
        var value = __pool[key.toString()];
        delete __pool[key.toString()];
        if(jobs[key.toString()] != null){
            job.deleteJob(jobs[key.toString()]);
        }
        if(callback != null){
            callback({'key':key.toString(),'value':value});
        }
    }
    logger('DEL\t'.red + (key.toString()).grey);
}

module.exports.clear = function(){
    for(var key in __pool){
        cache.del(key);
    }
}